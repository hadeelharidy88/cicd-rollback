
version: 2.1

commands:
   #Exercise - Rollback
   destroy_environment:
     steps:
       - run:
           name: Destroy environment
           
           command: |
             aws delete-stack --stack-name myStack-${CIRCLE_WORKFLOW_ID:0:7}

           when: on_fail


jobs:
  create_infrastructure:
   docker:
      - image: amazon/aws-cli
    
   steps:
      - checkout
      - run:
          name: "Create Cloudformation Stack"
          command: |
            aws cloudformation deploy --template-file template.yml --stack-name myStack-${CIRCLE_WORKFLOW_ID:0:7} --region us-east-1
      - run: return 1
        
      - destroy_environment
        

    
  # smoke_test:
  #  docker:
  #     - image: alpine:latest
  #  steps:
  #     - run:
  #         name: simulate error
  #      # Fail the job intentionally to simulate an error.
  #         command: |
  #           return 1
  #         when: on_fail
  #     - destroy_environment
          
          
         

workflows:
  workflow:
    jobs:
      - create_infrastructure:
           context: 
             - CLI
      # - smoke_test:
      #      requires:
      #        - create_infrastructure
           

